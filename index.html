<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roofing Business Priority Manager</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    .auth-container, .main-app { display: none; }
    .auth-container { display: flex; align-items: center; justify-content: center; height: 100vh; }
    .auth-card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
    .form-control { width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
    .btn { padding: 10px 20px; border: none; border-radius: 4px; background: #2196f3; color: white; font-weight: bold; cursor: pointer; }
    .btn:hover { background: #1976d2; }
    .container { padding: 20px; max-width: 900px; margin: auto; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="auth-container" id="authContainer">
    <div class="auth-card">
      <h2>🏠 Roofing Priority Manager</h2>
      <p style="color: #666;">Enter password to access your dashboard</p>
      <input type="password" id="passwordInput" class="form-control" placeholder="Enter password">
      <button onclick="doLogin()" class="btn">Login</button>
    </div>
  </div>

  <!-- Main App -->
  <div class="main-app" id="mainApp">
    <div class="container">
      <h1>🗂️ Roofing Business Priority Manager</h1>
      <button onclick="doLogout()" class="btn" style="background:#f44336;margin:10px 0;">Logout</button>
      <div>
        <form id="taskForm" onsubmit="return addTask()">
          <input type="text" id="taskTitle" class="form-control" placeholder="Task Title" required>
          <input type="text" id="taskAssignee" class="form-control" placeholder="Assigned To">
          <input type="date" id="taskDueDate" class="form-control">
          <button type="submit" class="btn">➕ Add Task</button>
        </form>
      </div>
      <hr>
      <div id="taskList"></div>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDKlGwerX5T957lylXhH5GTfpWbRK0w1cQ",
    authDomain: "alpaca-pmanager.firebaseapp.com",
    projectId: "alpaca-pmanager",
    storageBucket: "alpaca-pmanager.appspot.com",
    messagingSenderId: "325989588901",
    appId: "1:325989588901:web:6196e79365b45a34a8124c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUserUID = null;
  let allTasks = [];

  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      currentUserUID = user.uid;
      document.getElementById('authContainer').style.display = 'flex';
    } else {
      firebase.auth().signInAnonymously();
    }
  });

  function doLogin() {
    const pwd = document.getElementById('passwordInput').value;
    if (pwd === 'roofing123') {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      initApp();
    } else {
      alert('Wrong password');
    }
  }

  function doLogout() {
    document.getElementById('authContainer').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('passwordInput').value = '';
  }

  async function initApp() {
    setTodayDate();
    await loadTasks();
    renderTasks();
  }

  function setTodayDate() {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("taskDueDate").value = today;
  }

  async function loadTasks() {
    try {
      const doc = await db.collection("shared").doc("roofing-tasks").get();
      if (doc.exists) {
        allTasks = doc.data().tasks || [];
      }
    } catch (e) {
      console.error("Failed to load tasks", e);
    }
  }

  async function saveTasks() {
    try {
      await db.collection("shared").doc("roofing-tasks").set({
        tasks: allTasks,
        updatedAt: new Date().toISOString()
      });
    } catch (e) {
      console.error("Failed to save tasks", e);
    }
  }

  function addTask() {
    const title = document.getElementById('taskTitle').value;
    const assignee = document.getElementById('taskAssignee').value;
    const due = document.getElementById('taskDueDate').value;
    const task = { title, assignee, due, created: new Date().toISOString() };
    allTasks.push(task);
    saveTasks();
    renderTasks();
    document.getElementById("taskForm").reset();
    setTodayDate();
    return false;
  }

  function renderTasks() {
    const list = document.getElementById('taskList');
    list.innerHTML = allTasks.map(t => `
      <div style="background:white;padding:10px;margin:10px 0;border-radius:6px;border-left:4px solid #2196f3;">
        <strong>${t.title}</strong><br>
        <small>👤 ${t.assignee || 'Unassigned'} | 📅 ${t.due}</small>
      </div>`).join('');
  }
</script>
</body>
</html>
